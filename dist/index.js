#!/usr/bin/env node
"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var _require=require("commander"),program=_require.program;var chok=require("chokidar");var fs=require("fs");var path=require("path");var shell=require("shelljs");var log=require("single-line-log").stdout;var perf=require("execution-time")();var readline=require("linebyline");var extractPath=require("extract-path");var _require2=require("querystring"),stringify=_require2.stringify;var App=function App(){_classCallCheck(this,App);var _=this;this.options=null;this.param="";this.extension="css";this.recursiveArr=[];this.hasImportedFiles=false;this.watchList=[];this.importedList=[];this.init=function(){this.initProgram()};this.walk=function(dir,done){var results=[];fs.readdir(dir,function(err,list){if(err)return done(err);var i=0;(function next(){var file=list[i++];if(!file)return done(null,results);file=path.join(dir,file);fs.stat(file,function(err,stat){if(stat&&stat.isDirectory()){_.walk(file,function(err,res){results=results.concat(res);next()})}else{results.push(file);next()}})})()})};this.initProgram=function(){program.option("-i, --input <folder>","input less folder").option("-o, --output <folder>","output less folder").option("-e, --extension <ext>","output file extension, eg. ' -e wxss '").option("--mid-name <str>","specify output file middle name, eg. ' --mid-name min '").option("-r, --recursive","compile less files recursively").option("-m, --minify","minify output file").option("-s, --source-map","generate source map files").option("--less-options <str>","specify original less-cli options, eg. ' --less-options \"-l --no-color\" '");program.parse();this.options=program.opts();this.initParam()};this.initParam=function(){if(!_.options.input){console.error("error: no input folder specified");shell.exit(1)}if(!fs.existsSync(_.options.input)){console.error("error: input folder does not exists, please create it first!");shell.exit(1)}if(_.options.sourceMap){_.param+="--source-map "}if(_.options.minify){_.param+="--clean-css "}var rec_fun;if(_.options.recursive){rec_fun=_.walk}else{rec_fun=function rec_fun(dir,c){fs.readdir(dir,c)}}rec_fun(_.options.input,function(err,files){files.forEach(function(file){if(path.extname(file)===".less"&&!path.basename(file).startsWith("_")){if(_.options.recursive){_.watchList.push(path.normalize(file))}else{_.watchList.push(path.normalize(path.join(_.options.input,file)))}}});_.getImported(_.watchList);_.watchList.forEach(function(f){chok.watch(f).on("all",function(event,path){if(event==="add"){console.log("lessby is watching [".concat(path,"], waiting for changes..."))}if(event==="change"){perf.start();log("[*] [".concat(path,"] has changed, recompiling..."));_.getShell(path)}})})})};this.getImported=function(list){list.forEach(function(f){var importedFile={parent:f};if(!fs.existsSync(f)){return false}var rl=readline(f);rl.on("line",function(line,lineCount,byteCount){if(!line.startsWith("@import ")){return false}var _regex=new RegExp(/ \(reference\)/g);if(_regex.test(line)){console.log("[".concat(lineCount,": ").concat(line,"], skipping reference file..."));return false}extractPath(line,{validateFileExists:false}).then(function(p){importedFile.self=path.normalize(path.join(_.options.input,p));_.watchImported(importedFile);_.getImported([importedFile.self])})}).on("error",function(e){console.log(e)})})};this.watchImported=function(importedFile){var _self=importedFile.self;var _parent=importedFile.parent;chok.watch(_self).on("all",function(event,path){if(event==="add"){console.log("lessby is watching imported file [".concat(path,"], waiting for changes..."))}if(event==="change"){perf.start();log("[*] [".concat(path,"] has changed, recompiling its parent file [").concat(_parent,"]..."));_.getShell(_parent)}})};this.getShell=function(p){var output_folder=_.options.output?_.options.output:path.dirname(p);var output_name=path.parse(p).name;var lessOptions=_.options.lessOptions?_.options.lessOptions:"";var rc_opf=null;if(_.options.recursive){var _i=path.normalize(_.options.input);var _o=path.normalize(_.options.output?_.options.output:_i);var _p=path.normalize(p);rc_opf=path.dirname(_p.replace(_i,_o))}var e=_.options.extension?_.options.extension:_.extension;if(_.options.midName){output_name="".concat(output_name,".").concat(_.options.midName)}var op=rc_opf?"".concat(rc_opf,"/").concat(output_name,".").concat(e):"".concat(output_folder,"/").concat(output_name,".").concat(e);var sh="npx lessc ".concat(lessOptions," ").concat(_.param," \"").concat(p,"\" \"").concat(op,"\"");_.execShell(sh,p)};this.execShell=function(script,name){shell.exec(script,{silent:true},function(code,stdout,stderr){if(stderr){console.log("\n\n"+stderr)}else{_.l("",name)}})};this.l=function(str,name){var t=perf.stop();var s=str?str:"Compiled in ".concat(parseInt(t.time),"ms.");console.log("");console.log("\x1B[32m%s\x1B[0m","[\u221A] [".concat(name,"] ").concat(s))}};var app=new App;app.init();