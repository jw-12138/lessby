#!/usr/bin/env node
"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var _require=require("commander"),program=_require.program;var chok=require("chokidar");var fs=require("fs");var path=require("path");var shell=require("shelljs");var perf=require("execution-time")();var App=function App(){_classCallCheck(this,App);var _=this;this.options=null;this.param="";this.extension="css";this.recursiveArr=[];this.watchList=[];this.init=function(){this.initProgram()};this.initialBuildDone=[];this.walk=function(dir,done){var results=[];fs.readdir(dir,function(err,list){if(err)return done(err);var i=0;(function next(){var file=list[i++];if(!file)return done(null,results);file=path.join(dir,file);fs.stat(file,function(err,stat){if(stat&&stat.isDirectory()){_.walk(file,function(err,res){results=results.concat(res);next()})}else{results.push(file);next()}})})()})};this.initProgram=function(){program.option("-i, --input <folder>","input less folder").option("-o, --output <folder>","output less folder").option("-e, --extension <ext>","output file extension, eg. ' -e wxss '").option("--mid-name <str>","specify output file middle name, eg. ' --mid-name min '").option("-b, --initial-build","compile less files before watch").option("--one-time","compile less files ony once").option("-r, --recursive","compile less files recursively").option("-m, --minify","minify output file").option("-s, --source-map","generate source map files").option("--source-map-inline","generate inline source map files").option("--less-options <str>","specify original less-cli options, eg. ' --less-options \"-l --no-color\" '");program.parse();this.options=program.opts();this.initParam()};this.initParam=function(){if(!_.options.input){console.error("error: no input folder specified");shell.exit(1)}if(!fs.existsSync(_.options.input)){console.error("error: input folder does not exists, please create it first!");shell.exit(1)}if(_.options.sourceMap){_.param+="--source-map "}if(_.options.sourceMapInline){_.param.replace("--source-map ","");_.param+="--source-map-inline "}if(_.options.minify){_.param+="--clean-css "}var rec_fun;if(_.options.recursive){rec_fun=_.walk}else{rec_fun=function rec_fun(dir,c){fs.readdir(dir,c)}}rec_fun(_.options.input,function(err,files){if(err){console.log(err);if(!fs.lstatSync(_.options.input).isDirectory()){console.log("\n<-i> will only accept a folder, not a file!")}return}files.forEach(function(file){if(path.extname(file)===".less"&&!path.basename(file).startsWith("_")){if(_.options.recursive){_.watchList.push(path.normalize(file))}else{_.watchList.push(path.normalize(path.join(_.options.input,file)))}}});if(!_.options.oneTime){_.watchList.forEach(function(el){console.log("\uD83D\uDE48 lessby is watching [".concat(el,"]"))})}if(_.options.initialBuild){console.log("\uD83D\uDE48 <-b, --initial-build> is passed, starting building...")}var watcher=chok.watch(_.watchList).on("all",function(event,path){if(event==="add"){if(_.options.initialBuild){perf.start();_.getShell(path,function(){_.initialBuildDone++;if(_.options.oneTime&&_.initialBuildDone===_.watchList.length){watcher.close().then(function(){return console.log("\uD83D\uDC4B bye")})}})}}if(event==="change"){perf.start();console.log("\uD83D\uDE48[".concat(path,"] has changed, recompiling..."));_.getShell(path)}})})};this.getShell=function(p,cb){var output_folder=_.options.output?_.options.output:path.dirname(p);var output_name=path.parse(p).name;var lessOptions=_.options.lessOptions?_.options.lessOptions:"";var rc_opf=null;if(_.options.recursive){var _i=path.normalize(_.options.input);var _o=path.normalize(_.options.output?_.options.output:_i);var _p=path.normalize(p);rc_opf=path.dirname(_p.replace(_i,_o))}var e=_.options.extension?_.options.extension:_.extension;if(_.options.midName){output_name="".concat(output_name,".").concat(_.options.midName)}var op=rc_opf?"".concat(rc_opf,"/").concat(output_name,".").concat(e):"".concat(output_folder,"/").concat(output_name,".").concat(e);var sh="npx lessc ".concat(lessOptions," ").concat(_.param," \"").concat(p,"\" \"").concat(op,"\"");_.execShell(sh,p,cb)};this.execShell=function(script,name,cb){shell.exec(script,{silent:true},function(code,stdout,stderr){if(stderr){console.log("\n\n"+stderr)}else{_.l("",name);cb&&cb()}})};this.l=function(str,name){var t=perf.stop();var s=str?str:"Compiled in ".concat(parseInt(t.time),"ms.");console.log("\x1B[32m%s\x1B[0m","\u2728 [".concat(name,"] ").concat(s))}};var app=new App;app.init();